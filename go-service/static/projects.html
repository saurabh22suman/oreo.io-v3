<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Projects CRUD</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      input, textarea, button { padding: 0.5rem; margin: 0.25rem 0; width: 360px; }
      ul { padding: 0; list-style: none; }
      li { margin: 0.25rem 0; }
      code { background: #f5f5f5; padding: 0.25rem 0.5rem; }
    </style>
  </head>
  <body>
    <h1>Projects CRUD</h1>
    <p>Use the Auth Tester to get a token first: <a href="/ui/auth.html">/ui/auth.html</a></p>
    <label>Bearer Token</label><br />
    <input id="token" placeholder="paste token here" /><br />
    <h2>Create</h2>
    <input id="name" placeholder="Project name" />
    <textarea id="desc" placeholder="Description"></textarea><br />
    <button id="create">Create</button>
    <h2>List</h2>
    <button id="refresh">Refresh List</button>
    <ul id="list"></ul>
    <pre id="out"></pre>
    <script>
      const out = document.getElementById('out');
      function show(obj){ out.textContent = JSON.stringify(obj, null, 2); }
      const base = location.origin + '/api/projects';

      async function authed(method, url, body) {
        const t = document.getElementById('token').value.trim();
        const headers = t ? { 'Authorization': 'Bearer ' + t } : {};
        if (body) headers['Content-Type'] = 'application/json';
        const resp = await fetch(url, { method, headers, body: body ? JSON.stringify(body) : undefined });
        let data; try { data = await resp.json(); } catch { data = await resp.text(); }
        return { status: resp.status, data };
      }

      async function refreshList() {
        const { status, data } = await authed('GET', base);
        show({ status, data });
        const list = document.getElementById('list');
        list.innerHTML = '';
        (Array.isArray(data) ? data : []).forEach(p => {
          const li = document.createElement('li');
          li.innerHTML = `<div><code>#${p.id}</code> ${p.name} â€” <small>${p.description||''}</small> ` +
            `<button data-id="${p.id}" class="edit">Edit</button> ` +
            `<button data-id="${p.id}" class="del">Delete</button> ` +
            `<button data-id="${p.id}" class="datasets">Datasets</button></div>` +
            `<div class="datasets-panel" id="ds-${p.id}" style="margin: .5rem 0 1rem 1rem; display:none;">
               <div><input placeholder="New dataset name" id="ds-name-${p.id}" style="width:260px"/> <button class="create-ds" data-id="${p.id}">Create Dataset</button></div>
               <ul class="ds-list"></ul>
             </div>`;
          list.appendChild(li);
        });
      }

      document.getElementById('refresh').onclick = refreshList;
      document.getElementById('create').onclick = async () => {
        const name = document.getElementById('name').value.trim();
        const description = document.getElementById('desc').value.trim();
        const r = await authed('POST', base, { name, description });
        show(r);
        await refreshList();
      };

      document.getElementById('list').addEventListener('click', async (e) => {
        const id = e.target.getAttribute('data-id');
        if (e.target.className === 'del') {
          const r = await authed('DELETE', `${base}/${id}`);
          show(r);
          await refreshList();
        } else if (e.target.className === 'edit') {
          const name = prompt('New name?');
          const description = prompt('New description?');
          if (name !== null) {
            const r = await authed('PUT', `${base}/${id}`, { name, description });
            show(r);
            await refreshList();
          }
        } else if (e.target.className === 'datasets') {
          // Toggle dataset panel and load datasets
          const panel = document.getElementById(`ds-${id}`);
          const isHidden = panel.style.display === 'none';
          panel.style.display = isHidden ? 'block' : 'none';
          if (isHidden) {
            await loadDatasets(id);
          }
        } else if (e.target.className === 'create-ds') {
          const name = document.getElementById(`ds-name-${id}`).value.trim();
          if (!name) return;
          const r = await authed('POST', `${base}/${id}/datasets`, { name });
          show(r);
          await loadDatasets(id);
        }
      });

      async function loadDatasets(projectId) {
        const panel = document.getElementById(`ds-${projectId}`);
        const list = panel.querySelector('.ds-list');
        list.innerHTML = 'Loading...';
        const r = await authed('GET', `${base}/${projectId}/datasets`);
        if (r.status !== 200 || !Array.isArray(r.data)) {
          list.innerHTML = `<li>Failed to load datasets (${r.status})</li>`;
          return;
        }
        list.innerHTML = '';
        r.data.forEach(ds => {
          const li = document.createElement('li');
          li.innerHTML = `<div><code>#${ds.id}</code> ${ds.name}</div>
            <div>
              <input type="file" id="file-${projectId}-${ds.id}" style="width: 360px" />
              <button class="upload" data-pid="${projectId}" data-did="${ds.id}">Upload</button>
            </div>`;
          list.appendChild(li);
        });

        list.addEventListener('click', async (ev) => {
          if (ev.target.className === 'upload') {
            const pid = ev.target.getAttribute('data-pid');
            const did = ev.target.getAttribute('data-did');
            const fileInput = document.getElementById(`file-${pid}-${did}`);
            if (!fileInput.files || fileInput.files.length === 0) { alert('Choose a file first.'); return; }
            const fd = new FormData();
            fd.append('file', fileInput.files[0]);
            const t = document.getElementById('token').value.trim();
            const resp = await fetch(`${base}/${pid}/datasets/${did}/upload`, { method: 'POST', headers: t ? { 'Authorization': 'Bearer ' + t } : {}, body: fd });
            let data; try { data = await resp.json(); } catch { data = await resp.text(); }
            show({ status: resp.status, data });
          }
        }, { once: true });
      }
    </script>
  </body>
  </html>
